# Solana 交易执行系统设计文档

## 1. 系统概述

### 1.1 项目背景

本系统旨在提供一个简单的 Solana 链上交易执行系统，用户输入目标地址后自动完成代币转账交易。

### 1.2 系统目标

- 支持 Solana 链上代币转账
- 交易状态实时跟踪
- 交易历史记录查询
- 钱包余额监控
- 基础错误处理

## 2. 系统架构

### 2.1 核心模块

1. **Telegram Bot 模块**
   - Bot 命令处理
     - /start - 启动欢迎
     - /create_wallet - 创建新钱包
     - /import_wallet - 导入已有钱包
     - /balance - 查询余额
     - /transfer - 发起转账
     - /history - 查询历史
     - /help - 帮助信息
   - 用户会话管理
   - 消息交互流程
   - 内联键盘菜单

2. **钱包管理模块**
   - 钱包创建/导入
     - 生成新钱包
     - 导入已有钱包
     - 助记词管理
   - 余额查询
     - SOL余额
     - SPL代币余额
   - 私钥管理
     - 加密存储
     - 安全验证

3. **交易执行模块**
   - 交易构建
   - 交易签名
   - 交易广播

4. **交易监控模块**
   - 交易状态跟踪
   - 交易确认查询
   - 失败重试机制

5. **数据存储模块**
   - 交易记录
   - 地址管理
   - 系统日志

## 3. 技术栈选型

### 3.1 后端技术栈
- 开发语言：Golang
- Web 框架：Gin
- 数据库：PostgreSQL
- 缓存：Redis

### 3.2 链上交互
- Solana RPC 节点
- Solana Web3.js
- SPL Token 程序

## 4. 数据模型

### 4.1 核心数据表

1. **钱包表 (wallets)**
   - 钱包地址
   - 公钥信息
   - 创建时间
   - 状态

2. **交易记录表 (transactions)**
   - 交易哈希
   - 发送地址
   - 接收地址
   - 代币数量
   - 交易状态
   - 执行时间

3. **地址簿表 (addresses)**
   - 地址
   - 备注
   - 添加时间

4. **用户表 (users)**
   - 用户ID (Telegram ID)
   - 用户名
   - 注册时间
   - 用户状态
   - 最后活动时间

5. **用户会话表 (sessions)**
   - 会话ID
   - 用户ID
   - 会话状态
   - 会话数据
   - 过期时间

6. **用户钱包关联表 (user_wallets)**
   - 用户ID
   - 钱包地址
   - 是否默认
   - 备注名称

## 5. 接口设计

### 5.1 RESTful API

```
POST   /api/v1/transfer      # 发起转账
GET    /api/v1/tx/:hash      # 查询交易状态
GET    /api/v1/balance       # 查询余额
GET    /api/v1/history       # 查询交易历史
```

### 5.2 WebSocket API

```http
/ws/tx-status               # 交易状态推送
```

## 6. 安全设计

### 6.1 私钥管理
- 私钥加密存储
- 访问权限控制
- 签名验证机制

### 6.2 交易安全
- 交易金额限制
- 地址白名单
- 异常交易拦截

## 7. 部署方案

### 7.1 基础设施
- 主节点部署
- 备份节点部署
- 数据备份方案

### 7.2 监控告警
- 系统状态监控
- 交易异常告警
- 资金安全告警

## 8. 错误处理

### 8.1 常见错误
- 余额不足
- 网络超时
- 交易失败
- 签名错误

### 8.2 重试机制
- 自动重试策略
- 最大重试次数
- 重试间隔设置

## 9. 后续优化

### 9.1 功能优化
- 批量转账支持
- 多签名支持
- 交易记录导出

### 9.2 性能优化
- RPC 节点优化
- 并发处理优化
- 数据查询优化

## 10. Bot交互流程

### 10.1 基础流程
1. 用户首次启动
   - 发送欢迎消息
   - 引导用户创建/导入钱包
   - 展示基础功能菜单

2. 钱包操作流程
   - 创建新钱包
     1. 发送创建确认
     2. 生成钱包
     3. 展示助记词（私聊）
     4. 要求确认助记词

   - 导入钱包
     1. 请求助记词/私钥
     2. 验证有效性
     3. 导入确认

3. 转账流程
   - 输入接收地址
   - 输入金额
   - 确认交易详情
   - 执行转账
   - 返回交易结果

### 10.2 安全考虑
- 私密信息仅通过私聊发送
- 敏感操作需二次确认
- 会话超时自动清除
- 限制操作频率
- 异常行为检测

### 10.3 用户体验
- 内联键盘菜单
- 进度反馈
- 操作确认提示
- 错误友好提示
- 帮助文档快捷访问